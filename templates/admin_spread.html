<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Gi√° & Spread - Buser.com</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .admin-sidebar {
            background-color: #f8f8f8;
            border-right: 1px solid #ddd;
            padding: 15px;
            min-height: 80vh;
        }
        .admin-sidebar .nav-pills>li>a {
            color: #333;
            font-weight: bold;
            border-radius: 4px;
        }
        .admin-sidebar .nav-pills>li>a:hover {
            background-color: #eee;
        }
        .admin-sidebar .nav-pills>li.active>a {
            background-color: #2882C0;
            color: #fff;
        }
        .admin-main-content {
            padding: 20px;
        }
        .price-box {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .price-live {
            font-size: 24px;
            font-weight: bold;
            color: #2882C0;
        }
        .spread-input {
            max-width: 100px;
        }
    </style>
</head>

<body>
    <header>
        <nav class="navbar navbar-default" style="background-color: #2882C0; border: none; border-radius: 0;">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand" href="/" style="color: #fff; font-weight: bold;">BUSER.COM (ADMIN)</a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="index.html" style="color: #fff;"><i class="fa fa-home"></i> Trang ch·ªß</a></li>
                        <li><a href="login.html" style="color: #fff;"><i class="fa fa-sign-out"></i> ƒêƒÉng xu·∫•t</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-3 admin-sidebar">
                <ul class="nav nav-pills nav-stacked">
                    <li><a href="admin_dashboard.html"><i class="fa fa-dashboard"></i> T·ªïng quan</a></li>
                    <li><a href="admin_history.html"><i class="fa fa-history"></i> L·ªãch s·ª≠ Giao d·ªãch</a></li>
                    <li><a href="admin_users.html"><i class="fa fa-users"></i> Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</a></li>
                    <li><a href="admin_kyc.html"><i class="fa fa-id-card"></i> Qu·∫£n l√Ω KYC</a></li>
                    <li class="active"><a href="admin_spread.html"><i class="fa fa-line-chart"></i> Qu·∫£n l√Ω Gi√° & Spread</a></li>
                    <li><a href="admin_settings.html"><i class="fa fa-cogs"></i> C√†i ƒë·∫∑t Thanh to√°n</a></li>
                </ul>
            </div>

            <div class="col-sm-9 admin-main-content">
                <h2>üìä Qu·∫£n L√Ω Gi√° & Spread (Bi√™n ƒê·ªô)</h2>
                
                <div class="alert alert-info">
                    <strong>H∆∞·ªõng d·∫´n:</strong>
                    <ul style="margin-bottom: 0;">
                        <li><strong>Spread Mua:</strong> % tƒÉng gi√° khi kh√°ch mua (VD: 1.5% = kh√°ch tr·∫£ cao h∆°n 1.5%)</li>
                        <li><strong>Spread B√°n:</strong> % gi·∫£m gi√° khi kh√°ch b√°n (VD: 1.5% = b·∫°n tr·∫£ th·∫•p h∆°n 1.5%)</li>
                        <li>Gi√° ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông m·ªói 15 gi√¢y t·ª´ <strong>Binance + Forex API</strong></li>
                    </ul>
                </div>

                <!-- Gi√° USD/VND -->
                <div class="price-box">
                    <h4><i class="fa fa-dollar"></i> T·ª∑ Gi√° USD/VND</h4>
                    <div class="price-live" id="usd-vnd-rate">ƒêang t·∫£i...</div>
                    <small class="text-muted">C·∫≠p nh·∫≠t m·ªói gi·ªù t·ª´ API qu·ªëc t·∫ø</small>
                </div>

                <!-- B·∫£ng Spread -->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 style="margin:0;"><i class="fa fa-cogs"></i> C√†i ƒê·∫∑t Spread (Bi√™n ƒê·ªô L·ª£i Nhu·∫≠n)</h4>
                    </div>
                    <div class="panel-body">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Coin</th>
                                    <th>Gi√° G·ªëc (VND)</th>
                                    <th>Spread Mua (%)</th>
                                    <th>Gi√° B√°n Ra (VND)</th>
                                    <th>Spread B√°n (%)</th>
                                    <th>Gi√° Thu V·ªÅ (VND)</th>
                                    <th>H√†nh ƒê·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="spread-table-body">
                                <tr><td colspan="7" class="text-center">ƒêang t·∫£i...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Cache Status -->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 style="margin:0;"><i class="fa fa-database"></i> Tr·∫°ng Th√°i Cache (Debug)</h4>
                    </div>
                    <div class="panel-body">
                        <pre id="cache-status" style="background:#f9f9f9; padding:10px; border-radius:5px;">ƒêang t·∫£i...</pre>
                        <button class="btn btn-sm btn-info" onclick="loadCacheStatus()"><i class="fa fa-refresh"></i> L√†m m·ªõi</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
    <script src="/static/js/config.js"></script>
    <script src="/static/js/main.js"></script>

    <script>
        function getAuthToken() {
            const loginDataString = localStorage.getItem('buser_login_data');
            if (!loginDataString) return null;
            try { return JSON.parse(loginDataString).token; } catch (e) { return null; }
        }

        const token = getAuthToken();
        if (!token) {
            window.location.href = "login.html";
        }

        // T·∫£i t·ª∑ gi√° USD/VND
        function loadUsdVndRate() {
            $.ajax({
                url: `${API_URL}/api/usd-vnd-rate`,
                type: 'GET',
                success: function(res) {
                    $('#usd-vnd-rate').text(numberFormat(res.rate, 0) + ' VNƒê');
                }
            });
        }

        // T·∫£i Spread Config
        function loadSpreadConfig() {
            $.ajax({
                url: `${API_URL}/api/admin/get-spread`,
                type: 'GET',
                beforeSend: function(xhr) { xhr.setRequestHeader('Authorization', 'Bearer ' + token); },
                success: function(res) {
                    renderSpreadTable(res.spread_config);
                }
            });
        }

        // T·∫£i gi√° th·ª±c t·∫ø
        let currentPrices = {};
        function loadCurrentPrices() {
            $.ajax({
                url: `${API_URL}/api/all-prices`,
                type: 'GET',
                success: function(prices) {
                    currentPrices = prices;
                    renderSpreadTable();
                }
            });
        }

        function renderSpreadTable(spreadConfig) {
            if (!currentPrices || Object.keys(currentPrices).length === 0) {
                loadCurrentPrices();
                return;
            }

            $.ajax({
                url: `${API_URL}/api/admin/get-spread`,
                type: 'GET',
                beforeSend: function(xhr) { xhr.setRequestHeader('Authorization', 'Bearer ' + token); },
                success: function(res) {
                    const spreadConfig = res.spread_config;
                    const tableBody = $('#spread-table-body');
                    tableBody.empty();

                    const coins = ['bustabit', 'usdt', 'btc', 'eth', 'bnb', 'doge'];
                    
                    coins.forEach(coin => {
                        const prices = currentPrices[coin];
                        if (!prices) return;

                        const spread = spreadConfig[coin] || {buy: 1.015, sell: 0.985};
                        const buyPercent = ((spread.buy - 1) * 100).toFixed(2);
                        const sellPercent = ((1 - spread.sell) * 100).toFixed(2);

                        const midPrice = (prices.buy + prices.sell) / 2;

                        const row = `
                            <tr>
                                <td><strong>${coin.toUpperCase()}</strong></td>
                                <td>${numberFormat(midPrice, 0)} ‚Ç´</td>
                                <td>
                                    <input type="number" class="form-control spread-input" 
                                        id="buy-${coin}" value="${buyPercent}" step="0.1" min="0" max="10">
                                </td>
                                <td style="color: #d9534f; font-weight: bold;">${numberFormat(prices.buy, 0)} ‚Ç´</td>
                                <td>
                                    <input type="number" class="form-control spread-input" 
                                        id="sell-${coin}" value="${sellPercent}" step="0.1" min="0" max="10">
                                </td>
                                <td style="color: #5cb85c; font-weight: bold;">${numberFormat(prices.sell, 0)} ‚Ç´</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="updateSpread('${coin}')">
                                        <i class="fa fa-save"></i> L∆∞u
                                    </button>
                                </td>
                            </tr>
                        `;
                        tableBody.append(row);
                    });
                }
            });
        }

        function updateSpread(coin) {
            const buyPercent = parseFloat($(`#buy-${coin}`).val());
            const sellPercent = parseFloat($(`#sell-${coin}`).val());

            $.ajax({
                url: `${API_URL}/api/admin/update-spread`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    coin: coin,
                    buy_percent: buyPercent,
                    sell_percent: sellPercent
                }),
                beforeSend: function(xhr) { xhr.setRequestHeader('Authorization', 'Bearer ' + token); },
                success: function(res) {
                    alert(`‚úÖ ${res.message}`);
                    setTimeout(() => {
                        loadCurrentPrices();
                    }, 1000);
                },
                error: function(xhr) {
                    alert('‚ùå L·ªói: ' + xhr.responseJSON.message);
                }
            });
        }

        function loadCacheStatus() {
            $.ajax({
                url: `${API_URL}/api/debug/cache-status`,
                type: 'GET',
                success: function(res) {
                    $('#cache-status').text(JSON.stringify(res, null, 2));
                }
            });
        }

        // Kh·ªüi ch·∫°y
        loadUsdVndRate();
        loadCurrentPrices();
        loadCacheStatus();

        // Auto refresh m·ªói 30 gi√¢y
        setInterval(() => {
            loadCurrentPrices();
            loadUsdVndRate();
        }, 30000);
    </script>
</body>
</html>